<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Route Dashboard</title>
  <link rel="stylesheet" href="styles/styles.css" />
  <script src="scripts/script.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
  <a href="#" class="logo"><i class="fas fa-recycle"></i> E-Route</a>
  
  <div class="right-section">
    <div class="credit-score">
      ‚≠ê <span id="creditPoints">0</span> Points
    </div>
    <div class="profile-dropdown">
        <i class="fas fa-user-circle profile-icon" onclick="toggleDropdown()"></i>
        <div class="dropdown-content" id="profileDropdown" style="display: none;"></div>
    </div>
</header>

  <!-- Hero Section -->
 <section class="hero">
  <h1>Your technology partner for<br />
    <span class="highlight">Innovative and Impactful</span><br />
    E-Waste Facility Locator
  </h1>
  <p>Find E-waste facilities effortlessly with our platform. Your key to responsible recycling.</p>
  <div class="hero-buttons">
    <button onclick="goToLocator()">Locate Facility</button>
    <button onclick="showCreditForm()">Earn Credit Points</button>
  </div>
</section>


  <!-- Locator Section (Hidden by default) -->
  <section class="locator-section" id="locatorSection" style="display:none;">
  <div class="locator-header">
    <button class="back-btn" onclick="goBackToDashboard()">‚¨Ö Back to Dashboard</button>
    <input type="text" id="centerSearch" placeholder="Search for a center..." oninput="filterCenters()" />
  </div>
  <div id="map" style="height: 500px; margin-top: 20px;"></div>
  </section>
  <!--credit form section-->
  <section id="creditFormSection" style="display: none;">
  <div class="credit-form-container">
    <h2>Earn Credit Points</h2>
    <form id="creditForm">
      <div class="form-group">
        <label>‚ôªÔ∏è Recovered Items:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="items" value="Mobile" /> Mobile</label>
          <label><input type="checkbox" name="items" value="Laptop" /> Laptop</label>
          <label><input type="checkbox" name="items" value="TV" /> TV</label>
          <label><input type="checkbox" name="items" value="Printer" /> Printer</label>
          <label><input type="checkbox" name="items" value="Others" /> Others</label>
        </div>
      </div>

      <div class="form-group">
        <label>üî¢ Quantity:</label>
        <input type="number" id="quantity" name="quantity" required />
      </div>

      <div class="form-group">
        <label>üè∑Ô∏è Recovery Type:</label>
        <select id="recoveryType" name="recoveryType" required>
          <option value="" disabled selected> --Select the recovery type--</option>
          <option value="Shop Drop-off">Shop Drop-off</option>
          <option value="Online Booking">Online Booking</option>
          <option value="Others">Others</option>
        </select>
      </div>

      <div class="form-group">
        <label>üè™ Center Name:</label>
        <input type="text" id="centerName" name="centerName" />
      </div>

      <div class="form-group">
        <label>üìÖ Recovered Date:</label>
        <input type="date" id="recoveredDate" name="recoveredDate" />
      </div>

      <div class="form-group">
        <label>üìù Notes (optional):</label>
        <textarea id="notes" name="notes" rows="3"></textarea>
      </div>

      <div class="form-buttons">
        <button type="submit" class="save-btn">üíæ Save</button>
        <button type="button" class="cancel-btn" onclick="cancelCreditForm()">‚ùå Cancel</button>
      </div>
    </form>
  </div>
</section>


  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      alert("You must be logged in to view this page.");
      window.location.href = "index.html";
    }

    // Go to locator section
    function goToLocator() {
      document.querySelector('.hero').style.display = 'none';
      document.getElementById('locatorSection').style.display = 'block';
      setTimeout(initializeMap, 100);
    }

    //Back to dashboard
    function goBackToDashboard() {
        document.getElementById('locatorSection').style.display = 'none';
        document.querySelector('.hero').style.display = 'block';
    }

    // ==========================
    // üåç Smart Locator Map Logic
    // ==========================
    let allMarkers = [];
    let centerData = [];

    function initializeMap() {
      const map = L.map('map').setView([13.0827, 80.2707], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          L.marker([latitude, longitude])
            .addTo(map)
            .bindPopup("You are here")
            .openPopup();
        });
      }

      fetch("/api/centers")
        .then(res => res.json())
        .then(centers => {
          centerData = centers;

          centers.forEach(center => {
            const marker = L.marker([center.latitude, center.longitude])
              .addTo(map)
              .bindPopup(`
                <b>${center.name}</b><br>
                ${center.address}<br>
                Phone: ${center.phone}<br>
                ${center.bookingLink
                  ? `<button onclick="bookEwaste('${center._id}', '${center.bookingLink}')">Book Now</button>`
                  : `<span style="color:gray">Booking not available</span>`}
              `);
            marker.__mapRef = map;
            allMarkers.push({ marker, center });
          });
        })
        .catch(err => console.error("Error fetching centers:", err));
    }

    function filterCenters() {
        const input = document.getElementById("centerSearch").value.toLowerCase();

    allMarkers.forEach(({ marker, center }) => {
        const map = marker.__mapRef; // Reference to the map used during init
        const shouldShow = center.name.toLowerCase().includes(input);

        if (shouldShow) {
            if (!marker._map && map) {
                marker.addTo(map); // Re-add if previously removed
            }
        } else {
          if (marker._map) {
            marker.remove(); // Hide if it doesn't match
          }
        }
    });
}

    async function bookEwaste(centerId, bookingLink) {
      if (!token) return alert("Please login to book!");

      try {
        const res = await fetch("/api/bookings", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ centerId })
        });

        const data = await res.json();
        if (res.ok) {
          alert("Booking successful!");
          window.open(bookingLink, "_blank");
        } else {
          alert(data.message || "Booking failed");
        }
      } catch (err) {
        console.error("Booking error:", err);
        alert("Something went wrong.");
      }
    }
    document.getElementById("creditForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const selectedItems = [...document.querySelectorAll('input[name="items"]:checked')].map(el => el.value);
  const quantity = parseInt(document.getElementById("quantity").value);
  const recoveryType = document.getElementById("recoveryType").value;
  const centerName = document.getElementById("centerName").value;
  const recoveredDate = document.getElementById("recoveredDate").value;
  const notes = document.getElementById("notes").value;

  const token = localStorage.getItem("token");

  const res = await fetch("/api/user/credits", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({
      items: selectedItems,
      quantity,
      recoveryType,
      centerName,
      recoveredDate,
      notes
    })
  });

  const data = await res.json();
  if (res.ok) {
    alert(data.message || "‚úÖ Points updated!");
    document.getElementById("creditPoints").innerText = data.updatedCredits;
    //Return to dashboard
    document.getElementById("creditForm").reset();
    document.getElementById("creditFormSection").style.display = "none";
    document.querySelector(".hero").style.display = "block";
  } else {
    alert(data.message || "Something went wrong.");
  }
});
  </script>
</body>
</html>
